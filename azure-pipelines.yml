trigger:
  - main

variables:
  nodeVersion: "22.12.0"
  buildConfiguration: "production"
  apiUrl: "https://umqapidt.kacst.gov.sa/"

stages:
  - stage: Build
    displayName: "Build Angular App"
    jobs:
      - job: BuildJob
        displayName: "Build Angular App"
        pool:
          vmImage: "windows-latest"

        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: "$(nodeVersion)"
            displayName: "Install Node.js"

          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(npm_config_cache)
            displayName: "Cache npm packages"

          - script: |
              npm install --legacy-peer-deps
            displayName: "Install dependencies"

          - script: |
              npm run test -- --watch=false --browsers=ChromeHeadless --code-coverage
            displayName: "Run tests"
            continueOnError: true

          - task: PublishTestResults@2
            inputs:
              testResultsFormat: "JUnit"
              testResultsFiles: "**/TESTS-*.xml"
              searchFolder: "$(System.DefaultWorkingDirectory)"
              testRunTitle: "Angular App Tests"
            condition: always()
            displayName: "Publish test results"

          # Verify environment files before build
          - script: |
              echo "=== DEBUGGING ENVIRONMENT SETUP ==="
              echo "Checking environment files..."
              type src\environments\environment.ts
              echo "---"
              type src\environments\environment.prod.ts
              echo "=== END DEBUGGING ==="
            displayName: "Debug Environment Files"

          # Build Angular app with production configuration
          - script: |
              echo "Building Angular app with API URL: $(apiUrl)"
              echo "Using production configuration..."
              npm run build:prod
            displayName: "Build Angular App"

          # Verify build output contains correct API URL
          - script: |
              echo "=== VERIFYING BUILD OUTPUT ==="
              findstr /s /i "umqapidt.kacst.gov.sa" dist\um-alquraa-angular\browser\*.js
              if %errorlevel% neq 0 (
                echo "ERROR: Production API URL not found in build output!"
                findstr /s /i "localhost" dist\um-alquraa-angular\browser\*.js
                exit 1
              )
              echo "SUCCESS: Production API URL found in build output"
              echo "=== END VERIFICATION ==="
            displayName: "Verify Build Output"

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: "dist"
              includeRootFolder: false
              archiveType: "zip"
              archiveFile: "$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip"
              replaceExistingArchive: true
            displayName: "Archive build files"

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "$(Build.ArtifactStagingDirectory)"
              ArtifactName: "angular-app"
              publishLocation: "Container"
            displayName: "Publish build artifacts"
